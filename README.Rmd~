```{r}
library(did)
data(mpdta)
head(mpdta)
attgt <- att_gt(yname="lemp",
                idname="countyreal",
                gname="first.treat",
                tname="year",
                data=mpdta,
                control_group="nevertreated",
                base_period="universal")
tw <- twfe_weights(attgt)
sum(tw$wTWFEgt * tw$attgt)

attgt2$att[attgt2$att != 0] <- results2$attgt

sum(tw$wTWFEgt[6:20] * attgt2$att)

library(fixest)
mpdta$post <- 1*( (mpdta$year >= mpdta$first.treat) & (mpdta$treat==1) )
feols(lemp ~ post | countyreal + year, cluster="countyreal", data=mpdta)


# write a function to compute att(g,t)
# I compute these as averages using weights, but it 
# is fine to use subsets of data here too.
# @param w weights, used for bootstrap
# @param base_period, allows base period to optionally 
#  be fixed at one
compute.attgt <- function(data, w=rep(1,nrow(data)),
                          use_base_period_1=FALSE) {
  # data frame to store results
  results <- list()
  counter <- 1
  
  for (this_t in tlist[-1]) {
    for (this_g in glist) {
      base_period <- min(this_t-1, this_g-1)
      if (use_base_period_1) base_period <- min(data$tp)
      G <- 1*(data$G==this_g)
      U <- 1*(data$G==0)
      pre <- 1*(data$tp == base_period)
      post <- 1*(data$tp == this_t)
      pg <- weighted.mean(data$G == this_g, w=w)
      pu <- weighted.mean(data$G == 0, w=w)
      ppre <- mean(pre)
      ppost <- mean(post)
      
      this_attgt <- weighted.mean(data$lemp*G*post/pg/ppost, w=w) -
                          weighted.mean(data$lemp*G*pre/pg/ppre, w=w) - 
        (weighted.mean(data$lemp*U*post/pu/ppost, w=w) -
           weighted.mean(data$lemp*U*pre/pu/ppre, w=w))
      results[[counter]] <- c(attgt=this_attgt, g=this_g, t=this_t)
      
      counter <- counter+1
    }
  }
  
  # convert to data frame
  results <- as.data.frame(do.call("rbind", results))
  
  results
}


tlist <- sort(unique(mpdta$year))
glist <- sort(unique(mpdta$first.treat))
mpdta$G <- mpdta$first.treat
mpdta$tp <- mpdta$year
results <- compute.attgt(mpdta)

# this computes "ATT(g,t)'s" using base period = 1 
# everywhere which is analogous to above equation
results2 <- compute.attgt(mpdta, use_base_period_1=TRUE)
# compute weights but allow for non-zero weights 
# in pre-treatment periods 
wTWFEgt_num2 <- sapply(1:nrow(results), 
                       function(i) wTWFE_num(results$g[i],
                                             results$t[i],
                                             post0=FALSE))
wTWFEgt_den2 <- sapply(1:nrow(results), 
                       function(i) wTWFE_num(results$g[i],
                                             results$t[i],
                                             post0=TRUE))
wTWFEgt2 <- wTWFEgt_num2/sum(wTWFEgt_den2)
# check if this delivers alpha
sum(results2$attgt*wTWFEgt2)
```
